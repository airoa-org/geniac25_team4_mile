Bootstrap: docker
From: pytorch/pytorch:2.5.1-cuda12.4-cudnn9-runtime

%post
    # Set environment variables
    export DEBIAN_FRONTEND=noninteractive
    export TZ=Asia/Tokyo
    
    # Update system and install basic packages
    apt-get update && apt-get install -y \
        wget \
        curl \
        git \
        vim \
        build-essential \
        cmake \
        pkg-config \
        software-properties-common \
        ca-certificates \
        gnupg \
        lsb-release \
        python3 \
        python3-pip \
        python3-dev \
        python3-venv \
        libffi-dev \
        libssl-dev \
        libxml2-dev \
        libxslt1-dev \
        libjpeg-dev \
        libpng-dev \
        libfreetype6-dev \
        libblas-dev \
        liblapack-dev \
        gfortran \
        libglib2.0-0 \
        libsm6 \
        libxext6 \
        libxrender-dev \
        libgomp1 \
        ffmpeg \
        && apt-get clean \
        && rm -rf /var/lib/apt/lists/*

    # Update conda
    conda update -n base -c defaults conda
    
    # Install additional conda packages
    conda install -y -c conda-forge \
        ffmpeg=4.3.1 \
        gymnasium=0.28.1 \
        jupyter=1.0.0
    
    # Install pip packages
    pip install \
        pytorch-lightning==2.4.0 \
        torchmetrics==1.4.0 \
        wandb==0.18.5 \
        timm==1.0.11 \
        hydra-core==1.3.2 \
        scipy==1.14.1 \
        fvcore==0.1.5.post20221221 \
        h5py==3.12.1 \
        opencv-python==4.10.0.84 \
        moviepy==1.0.3 \
        stable-baselines3==2.3.2 \
        importlib-resources==6.4.5 \
        imgaug==0.4.0 \
        scikit-video==1.1.11 \
        transformers==4.46.3 \
        yacs==0.1.8 \
        Pillow==10.4.0 \
        matplotlib==3.9.2 \
        pyyaml==6.0.2 \
        tqdm==4.66.5 \
        pytest==8.3.3 \
        black==24.10.0 \
        flake8==7.1.1 \
        ipywidgets==8.1.5
    
    # Set up environment for running
    echo "conda activate base" >> /opt/startup.sh
    chmod +x /opt/startup.sh

%environment
    export CUDA_HOME="/usr/local/cuda"
    export CUDA_PATH="/usr/local/cuda"
    export LD_LIBRARY_PATH="/usr/local/cuda/lib64:$LD_LIBRARY_PATH"
    export PYTHONPATH="/workspace:$PYTHONPATH"

%runscript
    source /opt/startup.sh
    exec "$@"

%startscript
    source /opt/startup.sh

%labels
    Author "Robot MILE Team"
    Version "2.0"
    Description "Container for Robot MILE: Language-Guided Robot Manipulation"
    Base_Image "pytorch/pytorch:2.5.1-cuda12.4-cudnn9-runtime"
    CUDA_Version "12.4"
    PyTorch_Version "2.5.1"

%help
    This container provides a complete environment for running Robot MILE.
    Based on PyTorch 2.5.1 with CUDA 12.4 support.
    
    Usage:
    1. Build the container:
       singularity build robot_mile.sif robot_mile.def
    
    2. Run interactive session:
       singularity shell --nv robot_mile.sif
    
    3. Run specific script:
       singularity exec --nv robot_mile.sif python train.py
    
    4. Bind workspace directory:
       singularity exec --nv -B $(pwd):/workspace robot_mile.sif python train.py
    
    5. Run Jupyter Notebook:
       singularity exec --nv -B $(pwd):/workspace robot_mile.sif \
         jupyter notebook --ip=0.0.0.0 --port=8888 --no-browser --allow-root
    
    Note: Use --nv flag for NVIDIA GPU support 